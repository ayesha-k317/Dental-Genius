<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dental Genius - Dashboard</title>

  <link rel="stylesheet" href="Staff-Dashboard.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css"/>
</head>
<body>
  <div class="container">
    <div class="container fade-in-dashboard">

      <!-- Dynamic Welcome Message -->
      <div class="welcome-text">WELCOME, <span id="username">[NAME]</span></div>

      <!-- Appointments Section -->
      <section class="appointments">
        <h3>Appointments Booked</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>No</th>
                <th>Date</th>
                <th>Name</th>
                <th>Treatment</th>
              </tr>
            </thead>
          </table>
          <div class="table-scroll">
            <table>
              <tbody class="appointment-data"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Patients Section -->
      <section class="patient">
        <h3>Patient List</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>No</th>
                <th>Name</th>
                <th>Email Address</th>
              </tr>
            </thead>
          </table>
          <div class="table-scroll">
            <table>
              <tbody class="patient-data"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Logout Section -->
      <section class="Logout">
        <div class="logout">
          <a href="#" id="logoutBtn" title="Logout"><i class="ri-login-box-line"></i></a>
        </div>
      </section>
    </div>
  </div>

  <script>
    async function loadDashboardData() {
      try {
        // Check if user is authenticated
        const authRes = await fetch('/check-auth');
        const authData = await authRes.json();

        if (!authData.loggedIn) {
          alert('You are not logged in.');
          return window.location.href = '/Login.html';
        }

        // Update welcome name
        document.getElementById('username').textContent = authData.username;

        // Fetch appointment data
        const res = await fetch('/appointments-data');
        if (!res.ok) throw new Error('Failed to fetch appointments.');

        const appointments = await res.json();

        const appointmentTable = document.querySelector('.appointment-data');
        const patientTable = document.querySelector('.patient-data');

        appointmentTable.innerHTML = '';
        patientTable.innerHTML = '';

        const uniquePatients = new Map();

        appointments.forEach((appt, index) => {
          // Add to Appointments Table
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${new Date(appt.appointmenttime).toLocaleString()}</td>
            <td>${appt.firstname} ${appt.lastname}</td>
            <td>${appt.treatment}</td>
          `;
          appointmentTable.appendChild(row);

          // Add to Patient Table (unique only)
          const patientKey = appt.email;
          if (!uniquePatients.has(patientKey)) {
            const pRow = document.createElement('tr');
            pRow.innerHTML = `
              <td>${uniquePatients.size + 1}</td>
              <td>${appt.firstname} ${appt.lastname}</td>
              <td>${appt.email}</td>
            `;
            patientTable.appendChild(pRow);
            uniquePatients.set(patientKey, true);
          }
        });

      } catch (err) {
        alert('Error loading dashboard: ' + err.message);
        console.error(err);
        window.location.href = '/Login.html';
      }
    }

    // Logout handler
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('logoutBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        await fetch('/logout', { method: 'POST' });
        window.location.href = '/Login.html';
      });

      loadDashboardData();
    });
  </script>
</body>
</html>
