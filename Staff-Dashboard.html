<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Dashboard</title>
  <link rel="stylesheet" href="StaffDashboard.css" /> <!-- your CSS -->
</head>
<body>
  <div class="dashboard-container">

    <h1>Staff Dashboard</h1>

    <div class="btn-group">
      <button id="btn-future" class="active">Future Appointments</button>
      <button id="btn-past">Past Appointments</button>
    </div>

    <section id="appointments-section">
      <h2>Appointments</h2>
      <p id="appointments-empty" style="display:none;">No appointments to display.</p>
      <table class="appointments-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Date & Time</th>
            <th>Patient Name</th>
            <th>Treatment</th>
          </tr>
        </thead>
        <tbody class="future-rows"></tbody>
        <tbody class="past-rows" style="display:none;"></tbody>
      </table>
    </section>

    <section id="patients-section">
      <h2>Patients</h2>
      <p id="patients-empty" style="display:none;">No patients found.</p>
      <table class="patients-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Email</th>
          </tr>
        </thead>
        <tbody class="patient-data"></tbody>
      </table>
    </section>

  </div>

  <script>
    (() => {
      const btnFuture = document.getElementById('btn-future');
      const btnPast = document.getElementById('btn-past');
      const futureRows = document.querySelector('.future-rows');
      const pastRows = document.querySelector('.past-rows');
      const appointmentsEmpty = document.getElementById('appointments-empty');
      const patientsEmpty = document.getElementById('patients-empty');
      const patientTbody = document.querySelector('.patient-data');

      function formatName(firstName, lastName) {
        if (firstName && lastName) return firstName + ' ' + lastName;
        if (firstName) return firstName;
        if (lastName) return lastName;
        return 'No Name';
      }

      function toggleButtons(showFuture) {
        if (showFuture) {
          btnFuture.classList.add('active');
          btnPast.classList.remove('active');
          futureRows.style.display = '';
          pastRows.style.display = 'none';
        } else {
          btnFuture.classList.remove('active');
          btnPast.classList.add('active');
          futureRows.style.display = 'none';
          pastRows.style.display = '';
        }
        updateAppointmentsEmpty();
      }

      function updateAppointmentsEmpty() {
        const visibleTbody = futureRows.style.display !== 'none' ? futureRows : pastRows;
        const hasRows = visibleTbody.children.length > 0;
        appointmentsEmpty.style.display = hasRows ? 'none' : 'block';
      }

      function updatePatientsEmpty() {
        const hasPatients = patientTbody.children.length > 0;
        patientsEmpty.style.display = hasPatients ? 'none' : 'block';
      }

      btnFuture.addEventListener('click', () => toggleButtons(true));
      btnPast.addEventListener('click', () => toggleButtons(false));

      async function fetchAppointments() {
        try {
          const res = await fetch('/appointments');
          const data = await res.json();

          const now = new Date();

          futureRows.innerHTML = '';
          pastRows.innerHTML = '';
          patientTbody.innerHTML = '';

          const patientsMap = new Map();

          data.forEach((appt, idx) => {
            const apptDate = new Date(appt.appointmentTime);
            const validDate = !isNaN(apptDate.getTime());

            const dateStr = validDate ? apptDate.toLocaleString() : 'Invalid Date';

            const fullName = formatName(appt.firstName, appt.lastName);

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${idx + 1}</td>
              <td>${dateStr}</td>
              <td>${fullName}</td>
              <td>${appt.treatment || 'N/A'}</td>
            `;

            if (validDate && apptDate > now) {
              futureRows.appendChild(tr);
            } else {
              pastRows.appendChild(tr);
            }

            if (appt.email && !patientsMap.has(appt.email)) {
              patientsMap.set(appt.email, fullName);
            }
          });

          let patientIndex = 1;
          for (const [email, name] of patientsMap) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${patientIndex++}</td>
              <td>${name}</td>
              <td>${email}</td>
            `;
            patientTbody.appendChild(tr);
          }

          updateAppointmentsEmpty();
          updatePatientsEmpty();

          toggleButtons(true); // default show future

        } catch (err) {
          console.error('Failed to fetch appointments:', err);
          appointmentsEmpty.textContent = 'Error loading appointments.';
          appointmentsEmpty.style.display = 'block';
          patientsEmpty.textContent = 'Error loading patients.';
          patientsEmpty.style.display = 'block';
        }
      }

      fetchAppointments();
    })();
  </script>
</body>
</html>
